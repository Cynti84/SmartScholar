<app-dashboard-layout
  [title]="'Providers Management'"
  [menu]="menu"
  logoUrl="logo.png"
  (action)="onSidebarAction($event)"
>
  <section>
    <div class="provider-management" id="providers-export">
      <!-- Header -->
      <div class="header">
        <div class="header-content">
          <!-- <h1>Provider Management</h1> -->
          <p class="subtitle">Manage all scholarship providers and their activities</p>
        </div>
        <div class="header-actions">
          <button type="button" class="btn btn-secondary" (click)="exportProviders()">
            <mat-icon style="color: #4299e1">file_download</mat-icon>

            Export
          </button>
        </div>
      </div>

      <!-- Statistics Cards -->
      <div class="stats-cards">
        <div class="stat-card total">
          <div class="stat-icon"><mat-icon style="color: #4299e1">bar_chart</mat-icon></div>
          <div class="stat-details">
            <div class="stat-label">Total Providers</div>
            <div class="stat-value">{{ stats.totalProviders }}</div>
          </div>
        </div>
        <div class="stat-card active">
          <div class="stat-icon"><mat-icon style="color: #10b981">check_circle</mat-icon></div>
          <div class="stat-details">
            <div class="stat-label">Active</div>
            <div class="stat-value">{{ stats.activeProviders }}</div>
          </div>
        </div>
        <div class="stat-card pending">
          <div class="stat-icon"><mat-icon style="color: #f59e0b">hourglass_top</mat-icon></div>
          <div class="stat-details">
            <div class="stat-label">Pending</div>
            <div class="stat-value">{{ stats.pendingProviders }}</div>
          </div>
        </div>
        <div class="stat-card suspended">
          <div class="stat-icon"><mat-icon style="color: #ef4444">block</mat-icon></div>
          <div class="stat-details">
            <div class="stat-label">Suspended</div>
            <div class="stat-value">{{ stats.suspendedProviders }}</div>
          </div>
        </div>
      </div>

      <!-- Filters Section -->
      <div class="filters-section">
        <div class="search-box">
          <input
            type="text"
            [(ngModel)]="searchTerm"
            (input)="onSearchChange()"
            placeholder="Search providers by name, email, or contact person..."
            class="search-input"
          />
        </div>

        <div class="filters">
          <select [(ngModel)]="selectedStatus" (change)="onFilterChange()" class="filter-select">
            <option value="all">All Status</option>
            <option value="active">Active</option>
            <option value="pending">Pending</option>
            <option value="suspended">Suspended</option>
          </select>

          <select [(ngModel)]="selectedType" (change)="onFilterChange()" class="filter-select">
            <option value="all">All Types</option>

            <option *ngFor="let type of providerTypes" [value]="type">
              {{ type }}
            </option>
          </select>
        </div>
      </div>

      <!-- Results Info -->
      <div class="results-info">
        Showing {{ (currentPage - 1) * itemsPerPage + 1 }} -
        {{ Math.min(currentPage * itemsPerPage, filteredProviders.length) }}
        of {{ filteredProviders.length }} providers
      </div>

      <!-- Providers Table -->
      <div class="table-container">
        <table class="providers-table">
          <thead>
            <tr>
              <th>Provider</th>
              <th>Type</th>
              <th>Contact</th>
              <th>Scholarships</th>
              <th>Registered</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let provider of getPaginatedProviders()">
              <td class="provider-cell">
                <div class="provider-info">
                  <mat-icon *ngIf="selectedProvider">
                    {{ getTypeIcon(provider.type) }}
                  </mat-icon>

                  <div>
                    <div class="provider-name">
                      {{ provider.name }}
                    </div>
                    <!-- <div class="provider-contact-person">
                      {{ provider.phone || '‚Äî' }}
                    </div> -->
                  </div>
                </div>
              </td>
              <td>
                <span class="type-badge" [class]="'type-' + provider.type">
                  {{ provider.type | uppercase }}
                </span>
              </td>
              <td class="contact-cell">
                <div class="contact-info">
                  <div>
                    <div>{{ provider.email }}</div>
                  </div>
                  <div class="phone">{{ provider.phone || '‚Äî' }}</div>
                </div>
              </td>
              <td class="scholarships-cell">
                <div class="scholarship-stats">
                  <span class="total">{{ provider.postedScholarship }} posted</span>
                  <span class="active">{{ provider.activeScholarships }} active</span>
                </div>
              </td>
              <td>{{ formatDate(provider.registrationDate) }}</td>
              <td>
                <span [class]="'status-badge ' + getStatusClass(provider.status)">
                  {{ provider.status | uppercase }}
                </span>
              </td>
              <td class="actions-cell">
                <button
                  (click)="viewProviderDetails(provider)"
                  class="btn btn-view"
                  title="View Details"
                >
                  View
                </button>
                <button
                  *ngIf="provider.status === 'pending'"
                  (click)="confirmApprove(provider)"
                  class="btn btn-approve"
                  title="Approve"
                >
                  Approve
                </button>
                <button
                  *ngIf="provider.status === 'pending'"
                  (click)="confirmDecline(provider)"
                  class="btn btn-decline"
                  title="Decline"
                >
                  Decline
                </button>
                <button
                  *ngIf="provider.status === 'active'"
                  (click)="confirmSuspend(provider)"
                  class="btn btn-suspend"
                  title="Suspend"
                >
                  Suspend
                </button>
                <button
                  *ngIf="provider.status === 'suspended'"
                  (click)="confirmActivate(provider)"
                  class="btn btn-activate"
                  title="Activate"
                >
                  Activate
                </button>
                <button
                  *ngIf="provider.status === 'active' || provider.status === 'suspended'"
                  (click)="confirmDelete(provider)"
                  style="
                    background-color: #f56565;
                    color: white;
                    border: none;
                    padding: 0.3rem 0.6rem;
                    border-radius: 4px;
                    cursor: pointer;
                  "
                >
                  Delete
                </button>
              </td>
            </tr>
          </tbody>
        </table>

        <div *ngIf="filteredProviders.length === 0" class="empty-state">
          <div class="empty-icon"><mat-icon style="color: #4299e1">search</mat-icon></div>
          <h3>No providers found</h3>
          <p>Try adjusting your search or filter criteria</p>
        </div>
      </div>

      <!-- Pagination -->
      <div class="pagination" *ngIf="getTotalPages() > 1">
        <button
          (click)="changePage(currentPage - 1)"
          [disabled]="currentPage === 1"
          class="pagination-btn"
        >
          ‚Üê Previous
        </button>

        <div class="pagination-numbers">
          <button
            *ngFor="let page of [].constructor(getTotalPages()); let i = index"
            (click)="changePage(i + 1)"
            [class.active]="currentPage === i + 1"
            class="pagination-number"
          >
            {{ i + 1 }}
          </button>
        </div>

        <button
          (click)="changePage(currentPage + 1)"
          [disabled]="currentPage === getTotalPages()"
          class="pagination-btn"
        >
          Next ‚Üí
        </button>
      </div>
    </div>
  </section>
</app-dashboard-layout>

<!-- Logout confirm modal -->
<app-confirm-modal
  *ngIf="showLogoutModal"
  title="Log out"
  message="Are you sure you want to log out of SmartScholar?"
  (confirm)="confirmLogout()"
  (cancel)="cancelLogout()"
></app-confirm-modal>

<!-- Provider Details Modal -->
<div class="modal-overlay" *ngIf="showDetailsModal" (click)="closeDetailsModal()">
  <div class="modal-content details-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Provider Details</h2>
      <button class="close-btn" (click)="closeDetailsModal()">√ó</button>
    </div>

    <div class="modal-body" *ngIf="selectedProvider">
      <!-- Provider Overview -->
      <div class="provider-overview">
        <div class="overview-header">
          <div class="provider-icon-large">
            <mat-icon *ngIf="selectedProvider">
              {{ getTypeIcon(selectedProvider.type) }}
            </mat-icon>
          </div>
          <div class="overview-info">
            <h3>{{ selectedProvider.name }}</h3>
            <span [class]="'status-badge ' + getStatusClass(selectedProvider.status)">
              {{ selectedProvider.status | uppercase }}
            </span>
          </div>
        </div>
        <p class="description">{{ selectedProvider.description }}</p>
      </div>

      <!-- Tabs -->
      <div class="details-tabs">
        <div class="tab-content">
          <!-- Basic Information -->
          <div class="info-section">
            <h4>Basic Information</h4>
            <div class="info-grid">
              <div class="info-item">
                <label>Type</label>
                <span class="type-badge" [class]="'type-' + selectedProvider.type">
                  {{ selectedProvider.type | uppercase }}
                </span>
              </div>
              <div class="info-item">
                <label>Registration Date</label>
                <span>{{ formatDate(selectedProvider.registrationDate) }}</span>
              </div>
              <!-- <div class="info-item">
                <label>Last Active</label>
                <span>{{ getTimeSinceActive(selectedProvider.lastActive) }}</span>
              </div> -->
              <div class="info-item">
                <label>Contact Person</label>
                <span>{{ selectedProvider.contactPerson }}</span>
              </div>
            </div>
          </div>

          <!-- Contact Information -->
          <div class="info-section">
            <h4>
              <mat-icon style="color: #4299e1; vertical-align: middle">call</mat-icon>Contact
              Information
            </h4>
            <div class="info-grid">
              <div class="info-item">
                <label>Email</label>
                <span>{{ selectedProvider.email }}</span>
              </div>
              <div class="info-item">
                <label>Phone</label>
                <span>{{ selectedProvider.phone }}</span>
              </div>
              <!-- <div class="info-item">
                <label>Website</label>
                <a [href]="'https://' + selectedProvider.website" target="_blank">
                  {{ selectedProvider.website }}
                </a>
              </div> -->
              <div class="info-item full-width">
                <label>Address</label>
                <span>{{ selectedProvider.address }}</span>
              </div>
            </div>
          </div>

          <!-- Scholarship Statistics -->
          <div class="info-section">
            <h4>
              <mat-icon style="color: #4299e1; vertical-align: middle">school</mat-icon>Scholarship
              Statistics
            </h4>
            <div class="stats-grid">
              <div class="stat-box">
                <div class="stat-number">{{ selectedProvider.postedScholarship }}</div>
                <div class="stat-label">Total Posted</div>
              </div>
              <div class="stat-box">
                <div class="stat-number">{{ selectedProvider.activeScholarships }}</div>
                <div class="stat-label">Currently Active</div>
              </div>
              <div class="stat-box">
                <div class="stat-number">
                  {{ selectedProvider.postedScholarship - selectedProvider.activeScholarships }}
                </div>
                <div class="stat-label">Closed/Expired</div>
              </div>
            </div>
          </div>

          <!-- Verification Documents -->
          <div class="info-section">
            <h4>
              <mat-icon style="color: #4299e1; vertical-align: middle">assignment</mat-icon
              >Verification Documents
            </h4>
            <div class="documents-list">
              <div *ngIf="selectedProvider?.verificationDocs?.length; else noDocs">
                <div *ngFor="let doc of selectedProvider.verificationDocs" class="document-item">
                  <span class="doc-icon">
                    <mat-icon style="color: #ffffff">description</mat-icon>
                  </span>
                  <span class="doc-name">{{ doc }}</span>
                  <button class="btn-download" (click)="downloadDocument(doc)">Download</button>
                </div>
              </div>

              <ng-template #noDocs>
                <p>No verification documents available.</p>
              </ng-template>
            </div>
          </div>

          <!-- Activity Logs -->
          <!-- <div class="info-section">
            <h4>
              <mat-icon style="color: #4299e1; vertical-align: middle">history</mat-icon>Recent
              Activity
            </h4>
            <div class="activity-logs">
              <div *ngFor="let log of activityLogs" class="activity-item">
                <div class="activity-icon">
                  <mat-icon style="color: #4299e1">assignment</mat-icon>
                </div>
                <div class="activity-content">
                  <div class="activity-action">{{ log.action }}</div>
                  <div class="activity-details">{{ log.details }}</div>
                  <div class="activity-time">{{ formatDate(log.timestamp) }}</div>
                </div>
              </div>
            </div>
          </div> -->
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button (click)="closeDetailsModal()" class="btn btn-secondary">Close</button>
      <button
        *ngIf="selectedProvider?.status === 'active'"
        (click)="confirmSuspend(selectedProvider); closeDetailsModal()"
        class="btn btn-danger"
      >
        Suspend Provider
      </button>
      <button
        *ngIf="selectedProvider?.status === 'suspended'"
        (click)="confirmActivate(selectedProvider); closeDetailsModal()"
        class="btn btn-success"
      >
        Activate Provider
      </button>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal-overlay" *ngIf="showConfirmModal" (click)="closeConfirmModal()">
  <div class="modal-content confirm-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirm Action</h2>
      <button class="close-btn" (click)="closeConfirmModal()">√ó</button>
    </div>

    <div class="modal-body">
      <div class="confirm-content">
        <div class="confirm-icon" [class]="confirmAction">
          <span *ngIf="confirmAction === 'approve'">‚úì</span>
          <span *ngIf="confirmAction === 'decline'">‚úï</span>
          <span *ngIf="confirmAction === 'suspend'">üö´</span>
          <span *ngIf="confirmAction === 'activate'">‚úì</span>
          <span *ngIf="confirmAction === 'delete'">üóëÔ∏è</span>
        </div>

        <h3>
          {{
            confirmAction === 'approve'
              ? 'Approve Provider'
              : confirmAction === 'decline'
                ? 'Decline Provider'
                : confirmAction === 'suspend'
                  ? 'Suspend Provider'
                  : confirmAction === 'activate'
                    ? 'Activate Provider'
                    : confirmAction === 'delete'
                      ? 'Delete Provider'
                      : 'Confirm Action'
          }}
        </h3>

        <p *ngIf="confirmAction === 'approve'">
          Are you sure you want to approve <strong>{{ selectedProvider?.name }}</strong
          >? They will be able to post scholarships immediately.
        </p>
        <p *ngIf="confirmAction === 'decline'">
          Are you sure you want to decline <strong>{{ selectedProvider?.name }}</strong
          >? This action cannot be undone and they will need to re-register.
        </p>
        <p *ngIf="confirmAction === 'suspend'">
          Are you sure you want to suspend <strong>{{ selectedProvider?.name }}</strong
          >? Their active scholarships will remain visible but they won't be able to post new ones.
        </p>
        <p *ngIf="confirmAction === 'activate'">
          Are you sure you want to activate <strong>{{ selectedProvider?.name }}</strong
          >? They will regain full access to the platform.
        </p>
        <p *ngIf="confirmAction === 'delete'">
          Are you sure you want to permanently delete <strong>{{ selectedProvider?.name }}</strong
          >? This action cannot be undone.
        </p>

        <div
          class="reason-input"
          *ngIf="confirmAction === 'suspend' || confirmAction === 'decline'"
        >
          <label>Reason (optional)</label>
          <textarea
            [(ngModel)]="confirmReason"
            placeholder="Provide a reason for this action..."
            rows="3"
          ></textarea>
        </div>
      </div>
    </div>

    <div
      class="modal-footer"
      style="
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        padding: 1rem;
        border-top: 1px solid #e2e8f0;
      "
    >
      <!-- Cancel -->
      <button
        (click)="closeConfirmModal()"
        style="
          background-color: #e2e8f0;
          color: #1a202c;
          border: none;
          padding: 0.5rem 1rem;
          border-radius: 6px;
          cursor: pointer;
        "
      >
        Cancel
      </button>

      <!-- Confirm Action (Approve / Activate / Suspend / Delete) -->
      <button
        (click)="executeConfirmAction()"
        [ngStyle]="{
          'background-color':
            confirmAction === 'approve' || confirmAction === 'activate' ? '#10b981' : '#f56565',
          color: 'white',
          border: 'none',
          padding: '0.5rem 1rem',
          'border-radius': '6px',
          cursor: 'pointer',
        }"
      >
        {{
          confirmAction === 'approve'
            ? 'Approve'
            : confirmAction === 'suspend'
              ? 'Suspend'
              : confirmAction === 'activate'
                ? 'Activate'
                : confirmAction === 'delete'
                  ? 'Delete'
                  : 'Confirm'
        }}
      </button>
    </div>
  </div>
</div>
